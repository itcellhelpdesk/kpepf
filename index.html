<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPEPF Schedule View | IT Cell Helpdesk</title>
    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- jQuery, Bootstrap, DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <style>
        body {
            /*background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);*/
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        /* Login Container */
        .login-center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }
        
        .login-container {
            background: white;
            border-radius: 15px;
            padding: 35px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-out;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .login-header p {
            color: #666;
            font-size: 0.95rem;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            z-index: 10;
            font-size: 1.1rem;
        }
        
        .form-control {
            padding-left: 50px;
            height: 48px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            font-size: 0.95rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .login-error {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            height: 48px;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            background: #cccccc;
            transform: none;
            box-shadow: none;
        }
        
        .forgot-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            display: block;
            text-align: center;
            margin-top: 20px;
        }
        
        .forgot-link:hover {
            text-decoration: underline;
        }
        
        .brand-text {
            color: white;
            text-align: center;
            margin-top: 25px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        /* Main Content Styles */
        .main-content {
            display: none;
            width: 100%;
            max-width: 1400px;
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .receipt-badge {
            background-color: #198754;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .payment-badge {
            background-color: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .pdf-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .pdf-btn:hover {
            background-color: #c82333;
        }
        
        .total-row {
            background-color: #e9ecef !important;
            font-weight: bold;
        }
        
        .total-amount {
            color: #198754;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .confirmed-badge {
            background-color: #0d6efd;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .month-year-display {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .login-container {
                padding: 25px;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .result-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        @media (max-height: 600px) {
            body {
                align-items: flex-start;
                padding-top: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container (Centered) -->
    <div id="loginCenter" class="login-center-container">
        <div class="login-container">
            <div class="login-header">
                <h3><i class="bi bi-shield-lock"></i> KPEPF Login</h3>
                <p>IT Cell HelpDesk</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-icon">
                            <i class="bi bi-person-badge"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="loginUserId" 
                               placeholder="Enter User ID" 
                               required
                               autocomplete="username">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-group">
                        <span class="input-icon">
                            <i class="bi bi-key"></i>
                        </span>
                        <input type="password" 
                               class="form-control" 
                               id="loginPassword" 
                               placeholder="Enter Password" 
                               required
                               autocomplete="current-password">
                        <button type="button" class="toggle-password" id="loginTogglePassword">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="text-danger small mt-2" id="loginError" style="display: none;">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    <span id="loginErrorMessage"></span>
                </div>
                
                <button type="submit" class="btn btn-primary w-100 mt-1" id="loginButton">
                    <span class="button-text">Sign In</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
                
                <div class="text-center mt-3">
                    <a href="javascript:void(0)" 
                       class="forgot-link" 
                       onclick="openForgotPasswordPopup()">
                        <i class="bi bi-question-circle me-1"></i>
                        Forgot Password?
                    </a>
                </div>
            </form>
        </div>
        
        <div class="brand-text">
           Version • v1.0
        </div>
    </div>
    
    <!-- Main Content (Initially Hidden) -->
    <div id="mainContent" class="main-content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0"><i class="bi bi-check-circle"></i> KPEPF Schedule - Receipts & Payments</h4>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Filter Section -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">District Treasury</label>
                            <select class="form-select" id="district" required>
                                <option value="">Select</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">Month</label>
                            <select class="form-select" id="month">
                                <option value="">Select</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label class="form-label">Year</label>
                            <input type="text" class="form-control" id="year" placeholder="">
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Type</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="typeReceipt" name="type" value="Receipt" checked>
                                    <label for="typeReceipt">Receipt</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="typePayment" name="type" value="Payment">
                                    <label for="typePayment">Payment</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="viewConfirmedData()">
                                <i class="bi bi-eye"></i> View
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loadingSection" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Loading. Please wait...</p>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <div class="month-year-display">
                            <div class="result-header">
                                <h5 id="resultHeading" style="color: #667eea; margin: 0;"></h5>
                                <button id="pdfButton" class="pdf-btn" style="display: none;">
                                    <i class="bi bi-file-pdf"></i> PDF
                                </button>
                            </div>
                            <div id="summaryInfo" class="mt-2"></div>
                        </div>
                        
                        <div class="table-responsive">
                            <table id="resultsTable" class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Treasury</th>
                                        <th>Type</th>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Gross Total</th>
                                        <th>Document</th>
                                        <th>Confirmed</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="5" class="text-end fw-bold">Grand Total:</td>
                                        <td id="grandTotal" class="total-amount">0.00</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- No Results -->
                    <div id="noResultsSection" class="text-center py-5" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle fs-4"></i>
                            <h5 class="mt-2">No Records Found</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Configuration
        const API_KEY = "AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4";
        const SHEET_ID = "1J3hQtpZv4zyCUVANURf9B4lhORp2_ml-XlIWLZWR3aA";
        const LOGIN_SHEET_ID = "11wvVQ2G41ke3g6RdfYX8AJAl0w-fnf2NQ_Agufz0wXY";
        const RANGE = "response!A:I"; // Columns A to I (Timestamp to Confirm)
        const SETTINGS_SHEET = "settings";
        
        // Global variables
        let allDistricts = [];
        let currentData = [];
        let dataTable = null;
        let isAuthenticated = false;
        
        // Initialize when page loads
        $(document).ready(function() {
            console.log("KPEPF Confirmed View application loaded");
            
            // Check if already authenticated
            checkAuth();
            
            // Initialize login form
            initializeLogin();
            
            // Initialize PDF button
            $('#pdfButton').click(generatePDF);
            
            // Set current year as default
            const currentYear = new Date().getFullYear();
            $('#year').val(currentYear);
        });
        
        // Check authentication status
        function checkAuth() {
            const authToken = sessionStorage.getItem('kpepf_auth_token');
            const loginTime = sessionStorage.getItem('kpepf_login_time');
            
            if (authToken && loginTime) {
                const currentTime = new Date().getTime();
                const sessionAge = currentTime - parseInt(loginTime);
                const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 minutes
                
                if (sessionAge < SESSION_TIMEOUT) {
                    isAuthenticated = true;
                    showMainContent();
                } else {
                    // Session expired
                    logout();
                }
            }
        }
        
        // Show login container (centered)
        function showLogin() {
            $('#loginCenter').show();
            $('#mainContent').hide();
            $('#loginUserId').focus();
        }
        
        // Show main content
        function showMainContent() {
            $('#loginCenter').hide();
            $('#mainContent').show();
            loadDistricts();
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('kpepf_auth_token');
            sessionStorage.removeItem('kpepf_login_time');
            sessionStorage.removeItem('kpepf_user_name');
            sessionStorage.removeItem('kpepf_user_role');
            isAuthenticated = false;
            showLogin();
        }
        
        // Initialize login form
        function initializeLogin() {
            // Toggle password visibility
            $('#loginTogglePassword').click(function() {
                const passwordInput = $('#loginPassword');
                const icon = $(this).find('i');
                
                if (passwordInput.attr('type') === 'password') {
                    passwordInput.attr('type', 'text');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                } else {
                    passwordInput.attr('type', 'password');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                }
            });
            
            // Auto-focus on user ID
            $('#loginUserId').focus();
            
            // Auto-focus on password after user ID
            $('#loginUserId').on('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    $('#loginPassword').focus();
                }
            });
            
            // Auto-submit on password enter
            $('#loginPassword').on('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    $('#loginForm').submit();
                }
            });
            
            // Login form submission
            $('#loginForm').submit(async function(e) {
                e.preventDefault();
                
                const userId = $('#loginUserId').val().trim();
                const password = $('#loginPassword').val().trim();
                const loginButton = $('#loginButton');
                const errorDiv = $('#loginError');
                const errorText = $('#loginErrorMessage');
                
                // Reset errors
                errorDiv.hide();
                
                // Basic validation
                if (!userId || !password) {
                    errorText.text('Please enter User ID and Password');
                    errorDiv.show();
                    return;
                }
                
                // Show loading state
                loginButton.prop('disabled', true);
                loginButton.find('.button-text').text('Authenticating...');
                loginButton.find('.spinner-border').removeClass('d-none');
                
                try {
                    // Fetch credentials from Google Sheets
                    const settingsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${LOGIN_SHEET_ID}/values/${SETTINGS_SHEET}!A2:F?key=${API_KEY}`;
                    
                    const response = await fetch(settingsUrl);
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    const treasurySettings = data.values || [];
                    
                    let loginSuccessful = false;
                    let userName = '';
                    let userRole = '';
                    
                    // Check each row for matching credentials
                    for (let i = 0; i < treasurySettings.length; i++) {
                        const row = treasurySettings[i];
                        if (row[1] === userId && row[2] === password) {
                            loginSuccessful = true;
                            userName = row[1] || userId;
                            userRole = row[3] || 'User';
                            break;
                        }
                    }
                    
                    if (loginSuccessful) {
                        // Generate authentication token
                        const loginTime = new Date().getTime();
                        const random = Math.random().toString(36).substring(2);
                        const authToken = btoa(`${loginTime}:${random}:${userName}`);
                        
                        // Store authentication data
                        sessionStorage.setItem('kpepf_auth_token', authToken);
                        sessionStorage.setItem('kpepf_login_time', loginTime.toString());
                        sessionStorage.setItem('kpepf_user_name', userName);
                        sessionStorage.setItem('kpepf_user_role', userRole);
                        
                        // Show success
                        loginButton.find('.button-text').text('Success!');
                        loginButton.removeClass('btn-primary').addClass('btn-success');
                        
                        setTimeout(() => {
                            isAuthenticated = true;
                            showMainContent();
                        }, 1000);
                        
                    } else {
                        // Failed login
                        errorText.text('Invalid User ID or Password');
                        errorDiv.show();
                        
                        // Shake animation
                        $('#loginForm').addClass('shake');
                        setTimeout(() => {
                            $('#loginForm').removeClass('shake');
                        }, 500);
                    }
                    
                } catch (error) {
                    console.error('Login Error:', error);
                    errorText.text('Error connecting to server. Please try again later.');
                    errorDiv.show();
                    
                } finally {
                    // Reset button state
                    loginButton.prop('disabled', false);
                    loginButton.find('.button-text').text('Sign In');
                    loginButton.find('.spinner-border').addClass('d-none');
                    loginButton.removeClass('btn-success').addClass('btn-primary');
                }
            });
        }
        
        // Forgot Password Popup
        function openForgotPasswordPopup() {
            const width = 600;
            const height = 500;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            window.open(
                'https://script.google.com/macros/s/AKfycbztfDzKffRaQXd5-_JyYGr_I26_7cXbmCApixAxv6ps/dev',
                'ForgotPasswordPopup',
                `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes,toolbar=no,location=no`
            );
        }
        
        // Load districts from Google Sheets
        function loadDistricts() {
            $('#loadingSection').show();
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Treasuries!A:B?key=${API_KEY}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    $('#loadingSection').hide();
                    
                    if (data.values && data.values.length > 1) {
                        // Extract unique districts from column A (skip header)
                        const rows = data.values.slice(1);
                        const districtSet = new Set();
                        
                        rows.forEach(row => {
                            if (row[0] && row[0].trim()) {
                                districtSet.add(row[0].trim());
                            }
                        });
                        
                        allDistricts = Array.from(districtSet).sort();
                        
                        const select = $('#district');
                        allDistricts.forEach(district => {
                            select.append(new Option(district, district));
                        });
                        
                        console.log("Districts loaded:", allDistricts.length);
                    } else {
                        showMessage('No district data found in Treasuries sheet.', 'danger');
                    }
                })
                .catch(error => {
                    $('#loadingSection').hide();
                    console.error("Error loading districts:", error);
                    showMessage('Error loading districts. Please refresh the page.', 'danger');
                });
        }
        
        // View confirmed data based on filters
        function viewConfirmedData() {
            if (!isAuthenticated) {
                showLogin();
                return;
            }
            
            const district = $('#district').val();
            const month = $('#month').val();
            const year = $('#year').val();
            const type = $('input[name="type"]:checked').val();
            
            if (!district) {
                showMessage('Please select a District Treasury.', 'warning');
                return;
            }
            
            // Validate year if provided
            if (year && !/^\d{4}$/.test(year)) {
                showMessage('Please enter a valid 4-digit year.', 'warning');
                return;
            }
            
            // Show loading
            $('#loadingSection').show();
            $('#resultsSection').hide();
            $('#noResultsSection').hide();
            
            // Destroy existing DataTable if it exists
            if (dataTable) {
                dataTable.destroy();
                dataTable = null;
            }
            
            console.log("Fetching confirmed data with filters:", { district, month, year, type });
            
            // Fetch data from response sheet
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    $('#loadingSection').hide();
                    
                    if (data.values && data.values.length > 1) {
                        processData(data.values, district, month, year, type);
                    } else {
                        showMessage('No data found in response sheet.', 'info');
                        $('#noResultsSection').show();
                    }
                })
                .catch(error => {
                    $('#loadingSection').hide();
                    console.error("Error fetching data:", error);
                    showMessage('Error fetching data. Please try again.', 'danger');
                    $('#noResultsSection').show();
                });
        }
        
        // Process and filter data
        function processData(rows, district, month, year, type) {
            // Extract headers
            const headers = rows[0];
            const dataRows = rows.slice(1);
            
            // Find column indices
            const colIndex = {
                timestamp: headers.indexOf("Timestamp"),
                district: headers.indexOf("Name of District Treasury"),
                treasury: headers.indexOf("Name of Treasury"),
                type: headers.indexOf("Type"),
                month: headers.indexOf("Month"),
                year: headers.indexOf("Year"),
                grossTotal: headers.indexOf("Gross total"),
                document: headers.indexOf("Document"),
                confirm: headers.indexOf("Confirm")
            };
            
            // Filter data
            const filteredData = dataRows.filter(row => {
                // Check if all required columns exist
                if (colIndex.confirm === -1 || colIndex.district === -1) {
                    return false;
                }
                
                const rowDistrict = row[colIndex.district] || '';
                const rowType = row[colIndex.type] || '';
                const rowMonth = row[colIndex.month] || '';
                const rowYear = row[colIndex.year] || '';
                const rowConfirm = row[colIndex.confirm] || '';
                
                // Apply filters
                const matchesDistrict = rowDistrict.toString().trim() === district;
                const matchesType = rowType.toString().trim() === type;
                const matchesMonth = !month || rowMonth.toString().trim() === month;
                const matchesYear = !year || rowYear.toString().trim().replace(/^'/, '') === year;
                const isConfirmed = rowConfirm.toString().trim().toLowerCase() === 'yes';
                
                return matchesDistrict && matchesType && matchesMonth && matchesYear && isConfirmed;
            });
            
            currentData = filteredData;
            
            if (filteredData.length > 0) {
                displayData(filteredData, headers, colIndex, district, month, year, type);
                $('#resultsSection').show();
                $('#noResultsSection').hide();
            } else {
                $('#resultsSection').hide();
                $('#noResultsSection').show();
                $('#pdfButton').hide();
            }
        }
        
        // Display data in table
        function displayData(data, headers, colIndex, district, month, year, type) {
            const tableBody = $('#tableBody');
            tableBody.empty();
            
            let grandTotal = 0;
            
            data.forEach((row, index) => {
                const rowType = row[colIndex.type] || '';
                const rowMonth = row[colIndex.month] || '';
                const rowYear = row[colIndex.year] || '';
                const rowGrossTotal = row[colIndex.grossTotal] || '0';
                const rowTreasury = row[colIndex.treasury] || '';
                const rowDocument = row[colIndex.document] || '';
                
                // Parse gross total (remove apostrophe if present)
                const grossTotalStr = rowGrossTotal.toString().replace(/^'/, '');
                const grossTotalNum = parseFloat(grossTotalStr) || 0;
                grandTotal += grossTotalNum;
                
                // Format gross total for display
                const formattedGrossTotal = grossTotalNum.toLocaleString('en-IN', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                // Format year (remove apostrophe if present)
                const formattedYear = rowYear.toString().replace(/^'/, '');
                
                const rowHtml = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${escapeHtml(rowTreasury)}</td>
                        <td>
                            <span class="${rowType === 'Receipt' ? 'receipt-badge' : 'payment-badge'}">
                                ${escapeHtml(rowType)}
                            </span>
                        </td>
                        <td>${escapeHtml(rowMonth)}</td>
                        <td>${escapeHtml(formattedYear)}</td>
                        <td class="text-end">${formattedGrossTotal}</td>
                        <td>
                            ${rowDocument ? 
                                `<a href="${escapeHtml(rowDocument)}" target="_blank" 
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-file-pdf"></i> View
                                </a>` : 
                                '<span class="text-muted">No Document</span>'
                            }
                        </td>
                        <td>
                            <span class="confirmed-badge">
                                <i class="bi bi-check"></i> Confirmed
                            </span>
                        </td>
                    </tr>
                `;
                
                tableBody.append(rowHtml);
            });
            
            // Update totals
            const formattedGrandTotal = grandTotal.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            $('#grandTotal').text(formattedGrandTotal);
            
            // Update heading and summary
            updateHeading(district, month, year, type, data.length, grandTotal);
            
            // Show PDF button
            $('#pdfButton').show();
            
            // Initialize DataTable
            initializeDataTable();
        }
        
        // Update heading and summary information
        function updateHeading(district, month, year, type, count, total) {
            let heading = `${district} - Confirmed ${type}s`;
            
            if (month) heading += ` | Month: ${month}`;
            if (year) heading += ` | Year: ${year}`;
            
            $('#resultHeading').text(heading);
            
            // Update summary info
            const summary = `
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Records:</strong> ${count}
                    </div>
                    <div class="col-md-3">
                        <strong>Grand Total:</strong> ₹${total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </div>
                    <div class="col-md-3">
                        <strong>Type:</strong> ${type}
                    </div>
                    <div class="col-md-3">
                        <strong>Date:</strong> ${new Date().toLocaleDateString('en-IN')}
                    </div>
                </div>
            `;
            
            $('#summaryInfo').html(summary);
        }
        
        // Initialize DataTable
        function initializeDataTable() {
            dataTable = $('#resultsTable').DataTable({
                paging: true,
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                ordering: true,
                order: [[4, 'desc'], [3, 'asc']], // Sort by Year desc, then Month asc
                columnDefs: [
                    { orderable: false, targets: [0, 6, 7] } // Disable sorting for S.No, Document, and Confirm columns
                ],
                language: {
                    search: "Search records:",
                    lengthMenu: "Show _MENU_ records per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ records",
                    infoEmpty: "Showing 0 to 0 of 0 records",
                    infoFiltered: "(filtered from _MAX_ total records)",
                    zeroRecords: "No matching records found",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                }
            });
        }
        
        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4'
            });
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-IN');
            
            // Prepare data for PDF
            const pdfData = currentData.map((row, index) => {
                // Find column indices again
                const headers = ["Timestamp", "Name of District Treasury", "Name of Treasury", "Type", "Month", "Year", "Gross total", "Document", "Confirm"];
                const colIndex = {
                    treasury: headers.indexOf("Name of Treasury"),
                    type: headers.indexOf("Type"),
                    month: headers.indexOf("Month"),
                    year: headers.indexOf("Year"),
                    grossTotal: headers.indexOf("Gross total"),
                    document: headers.indexOf("Document")
                };
                
                const rowType = row[colIndex.type] || '';
                const rowMonth = row[colIndex.month] || '';
                const rowYear = row[colIndex.year] || '';
                const rowGrossTotal = row[colIndex.grossTotal] || '0';
                const rowTreasury = row[colIndex.treasury] || '';
                
                // Parse and format values
                const grossTotalNum = parseFloat(rowGrossTotal.toString().replace(/^'/, '')) || 0;
                const formattedYear = rowYear.toString().replace(/^'/, '');
                
                return [
                    index + 1,
                    rowTreasury,
                    rowType,
                    rowMonth,
                    formattedYear,
                    '₹' + grossTotalNum.toFixed(2)
                ];
            });
            
            // Calculate grand total
            const grandTotal = currentData.reduce((sum, row) => {
                const grossTotal = row[headers.indexOf("Gross total")] || '0';
                return sum + (parseFloat(grossTotal.toString().replace(/^'/, '')) || 0);
            }, 0);
            
            // Header
            doc.setFontSize(16);
            doc.text('KPEPF Confirmed Records Report', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`District: ${$('#district').val()}`, 14, 25);
            doc.text(`Month: ${$('#month').val() || 'All'}`, 14, 30);
            doc.text(`Year: ${$('#year').val() || 'All'}`, 14, 35);
            doc.text(`Type: ${$('input[name="type"]:checked').val()}`, 14, 40);
            doc.text(`Generated On: ${dateStr}`, 14, 45);
            
            doc.text(`Total Records: ${currentData.length}`, 180, 25);
            doc.text(`Grand Total: ₹${grandTotal.toFixed(2)}`, 180, 30);
            
            // Table
            doc.autoTable({
                startY: 50,
                head: [['S.No', 'Treasury', 'Type', 'Month', 'Year', 'Gross Total (₹)']],
                body: pdfData,
                theme: 'grid',
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 9
                },
                styles: {
                    cellPadding: 3,
                    fontSize: 8,
                    textColor: [0, 0, 0],
                    lineColor: [0, 0, 0],
                    lineWidth: 0.1
                },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 25, halign: 'center' },
                    3: { cellWidth: 25, halign: 'center' },
                    4: { cellWidth: 25, halign: 'center' },
                    5: { cellWidth: 30, halign: 'right' }
                },
                margin: { left: 10, right: 10 }
            });
            
            // Footer with total
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                body: [[
                    '',
                    '',
                    '',
                    '',
                    'Grand Total:',
                    '₹' + grandTotal.toFixed(2)
                ]],
                theme: 'plain',
                styles: {
                    fontStyle: 'bold',
                    fontSize: 9,
                    textColor: [0, 0, 0]
                },
                columnStyles: {
                    5: { halign: 'right' }
                },
                margin: { left: 10, right: 10 }
            });
            
            // Save PDF
            const fileName = `KPEPF_Confirmed_${$('#district').val().replace(/\s+/g, '_')}_${dateStr.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // Show message
        function showMessage(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="bi bi-info-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at top of card body
            const cardBody = document.querySelector('.card-body');
            cardBody.insertBefore(alertDiv, cardBody.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    $(alertDiv).alert('close');
                }
            }, 5000);
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text ? text.toString().replace(/[&<>"']/g, m => map[m]) : '';
        }
    </script>
</body>
</html>
